"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _crypto = _interopRequireDefault(require("crypto"));

var _pandaAuthHeader = require("panda-auth-header");

var _logger = _interopRequireDefault(require("./logger"));

var _responses = _interopRequireDefault(require("./responses"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var Cache,
    NotModified,
    UnsupportedMediaType,
    md5,
    method,
    indexOf = [].indexOf;
({
  NotModified,
  UnsupportedMediaType
} = _responses.default);

md5 = function (obj) {
  return _crypto.default.createHash('md5').update(JSON.stringify(obj), 'utf-8').digest("hex");
};

Cache = class Cache {
  constructor(request) {
    var ref, ref1, ref2, ref3;

    _logger.default.debug("Cache Headers:", request.headers);

    this.timestamp = null;
    this.inputTime = ((ref = request.headers) != null ? ref["if-modified-since"] : void 0) || ((ref1 = request.headers) != null ? ref1["If-Modified-Since"] : void 0);
    this.inputETag = ((ref2 = request.headers) != null ? ref2["if-none-match"] : void 0) || ((ref3 = request.headers) != null ? ref3["If-None-Match"] : void 0);
  }

  timeCheck(timestamp) {
    timestamp = new Date(Number(timestamp)).toUTCString();

    if (timestamp === this.inputTime) {
      throw new NotModified();
    } else {
      return this.timestamp = timestamp;
    }
  }

  hashCheck(content) {
    var etag;
    etag = md5(content);

    if (etag === this.inputETag) {
      throw new NotModified();
    } else {
      this.etag = etag;
    }

    return content;
  }

  setMaxAge(maxAge) {
    return this.maxAge = maxAge;
  }

};

method = function (signatures, handler) {
  // TODO: parse Accept header
  return async function (request, context) {
    var accept, base, cache, data, etag, header, lastModified, maxAge, metadata, params, ref, ref1, ref2, scheme, token;

    if (request.source === "cuddle-monkey") {
      _logger.default.debug("Detected a Cuddle Monkey preheater invocation. Short circuting request cycle.");

      return true;
    }

    if ((header = (ref = request.headers) != null ? ref['Authorization'] : void 0) != null) {
      ({
        scheme,
        params,
        token
      } = (0, _pandaAuthHeader.parse)(header));

      if (token) {
        request.authorization = {
          scheme,
          token
        };
      } else {
        request.authorization = {
          scheme,
          params
        };
      }
    }

    request.accept = "application/json";

    if ((header = ((ref1 = request.headers) != null ? ref1['accept'] : void 0) || ((ref2 = request.headers) != null ? ref2['Accept'] : void 0)) != null) {
      accept = header.split(",")[0];

      if ((base = signatures.response).mediatype == null) {
        base.mediatype = ["application/json"];
      }

      if (accept === "*/*") {
        request.accept = "applicaton/json";
      } else if (indexOf.call(signatures.response.mediatype, accept) < 0) {
        throw new UnsupportedMediaType(accept);
      } else {
        request.accept = accept;
      }
    }

    if (!signatures.response.cache) {
      return {
        data: await handler(request, context),
        metadata: {
          headers: {
            "Content-Type": request.accept
          }
        }
      };
    }

    ({
      maxAge,
      lastModified,
      etag
    } = signatures.response.cache);
    cache = new Cache(request);
    data = await handler(request, context, cache);
    metadata = {
      headers: {
        "Content-Type": request.accept
      }
    };

    if (maxAge === "manual") {
      metadata.headers["Cache-Control"] = `max-age=${cache.maxAge}`;
    } else {
      metadata.headers["Cache-Control"] = `max-age=${maxAge}`;
    }

    if (lastModified) {
      metadata.headers["Last-Modified"] = cache.timestamp;
    }

    if (etag) {
      metadata.headers.ETag = cache.etag || md5(data);
    }

    return {
      data,
      metadata
    };
  };
};

var _default = method;
exports.default = _default;
//# sourceMappingURL=data:application/json;base64,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QUFFRixXQUFPO0FBQUEsTUFBQSxJQUFBO0FBQUEsTUFBQTtBQUFBLEtBQVA7QUE1Q0YsRztBQUZPLENBQVQ7O2VBZ0RlLE0iLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgQ3J5cHRvIGZyb20gXCJjcnlwdG9cIlxuaW1wb3J0IHtwYXJzZX0gZnJvbSBcInBhbmRhLWF1dGgtaGVhZGVyXCJcbmltcG9ydCBsb2cgZnJvbSBcIi4vbG9nZ2VyXCJcbmltcG9ydCByZXNwb25zZXMgZnJvbSBcIi4vcmVzcG9uc2VzXCJcbntOb3RNb2RpZmllZCwgVW5zdXBwb3J0ZWRNZWRpYVR5cGV9ID0gcmVzcG9uc2VzXG5cbm1kNSA9IChvYmopIC0+XG4gIENyeXB0by5jcmVhdGVIYXNoKCdtZDUnKS51cGRhdGUoSlNPTi5zdHJpbmdpZnkob2JqKSwgJ3V0Zi04JykuZGlnZXN0KFwiaGV4XCIpXG5cbmNsYXNzIENhY2hlXG4gIGNvbnN0cnVjdG9yOiAocmVxdWVzdCkgLT5cbiAgICBsb2cuZGVidWcgXCJDYWNoZSBIZWFkZXJzOlwiLCByZXF1ZXN0LmhlYWRlcnNcbiAgICBAdGltZXN0YW1wID0gbnVsbFxuICAgIEBpbnB1dFRpbWUgPSByZXF1ZXN0LmhlYWRlcnM/W1wiaWYtbW9kaWZpZWQtc2luY2VcIl0gfHwgcmVxdWVzdC5oZWFkZXJzP1tcIklmLU1vZGlmaWVkLVNpbmNlXCJdXG4gICAgQGlucHV0RVRhZyA9IHJlcXVlc3QuaGVhZGVycz9bXCJpZi1ub25lLW1hdGNoXCJdIHx8IHJlcXVlc3QuaGVhZGVycz9bXCJJZi1Ob25lLU1hdGNoXCJdXG5cbiAgdGltZUNoZWNrOiAodGltZXN0YW1wKSAtPlxuICAgIHRpbWVzdGFtcCA9IG5ldyBEYXRlKE51bWJlciB0aW1lc3RhbXApLnRvVVRDU3RyaW5nKClcbiAgICBpZiB0aW1lc3RhbXAgPT0gQGlucHV0VGltZVxuICAgICAgdGhyb3cgbmV3IE5vdE1vZGlmaWVkKClcbiAgICBlbHNlXG4gICAgICBAdGltZXN0YW1wID0gdGltZXN0YW1wXG5cbiAgaGFzaENoZWNrOiAoY29udGVudCkgLT5cbiAgICBldGFnID0gbWQ1IGNvbnRlbnRcbiAgICBpZiBldGFnID09IEBpbnB1dEVUYWdcbiAgICAgIHRocm93IG5ldyBOb3RNb2RpZmllZCgpXG4gICAgZWxzZVxuICAgICAgQGV0YWcgPSBldGFnXG4gICAgY29udGVudFxuXG4gIHNldE1heEFnZTogKG1heEFnZSkgLT4gQG1heEFnZSA9IG1heEFnZVxuXG5tZXRob2QgPSAoc2lnbmF0dXJlcywgaGFuZGxlcikgLT5cbiAgIyBUT0RPOiBwYXJzZSBBY2NlcHQgaGVhZGVyXG4gIChyZXF1ZXN0LCBjb250ZXh0KSAtPlxuICAgIGlmIHJlcXVlc3Quc291cmNlID09IFwiY3VkZGxlLW1vbmtleVwiXG4gICAgICBsb2cuZGVidWcgXCJEZXRlY3RlZCBhIEN1ZGRsZSBNb25rZXkgcHJlaGVhdGVyIGludm9jYXRpb24uIFNob3J0IGNpcmN1dGluZyByZXF1ZXN0IGN5Y2xlLlwiXG4gICAgICByZXR1cm4gdHJ1ZVxuXG4gICAgaWYgKGhlYWRlciA9IHJlcXVlc3QuaGVhZGVycz9bJ0F1dGhvcml6YXRpb24nXSk/XG4gICAgICB7c2NoZW1lLCBwYXJhbXMsIHRva2VufSA9IHBhcnNlIGhlYWRlclxuICAgICAgaWYgdG9rZW5cbiAgICAgICAgcmVxdWVzdC5hdXRob3JpemF0aW9uID0ge3NjaGVtZSwgdG9rZW59XG4gICAgICBlbHNlXG4gICAgICAgIHJlcXVlc3QuYXV0aG9yaXphdGlvbiA9IHtzY2hlbWUsIHBhcmFtc31cblxuICAgIHJlcXVlc3QuYWNjZXB0ID0gXCJhcHBsaWNhdGlvbi9qc29uXCJcbiAgICBpZiAoaGVhZGVyID0gcmVxdWVzdC5oZWFkZXJzP1snYWNjZXB0J10gfHwgcmVxdWVzdC5oZWFkZXJzP1snQWNjZXB0J10pP1xuICAgICAgYWNjZXB0ID0gaGVhZGVyLnNwbGl0KFwiLFwiKVswXVxuICAgICAgc2lnbmF0dXJlcy5yZXNwb25zZS5tZWRpYXR5cGUgPz0gW1wiYXBwbGljYXRpb24vanNvblwiXVxuICAgICAgaWYgYWNjZXB0ID09IFwiKi8qXCJcbiAgICAgICAgcmVxdWVzdC5hY2NlcHQgPSBcImFwcGxpY2F0b24vanNvblwiXG4gICAgICBlbHNlIGlmIGFjY2VwdCBub3QgaW4gc2lnbmF0dXJlcy5yZXNwb25zZS5tZWRpYXR5cGVcbiAgICAgICAgdGhyb3cgbmV3IFVuc3VwcG9ydGVkTWVkaWFUeXBlIGFjY2VwdFxuICAgICAgZWxzZVxuICAgICAgICByZXF1ZXN0LmFjY2VwdCA9IGFjY2VwdFxuXG4gICAgIyBQcm9jZXNzIHRoZSBoYW5kbGVyIHdoaWxlIG1pbmRpbmcgdGhlIGNvbmRpdGlvbmFsIGNhY2hlIGhlYWRlcnMuXG4gICAgaWYgIXNpZ25hdHVyZXMucmVzcG9uc2UuY2FjaGVcbiAgICAgIHJldHVyblxuICAgICAgICBkYXRhOiBhd2FpdCBoYW5kbGVyIHJlcXVlc3QsIGNvbnRleHRcbiAgICAgICAgbWV0YWRhdGE6XG4gICAgICAgICAgaGVhZGVyczogXCJDb250ZW50LVR5cGVcIjogcmVxdWVzdC5hY2NlcHRcblxuICAgIHttYXhBZ2UsIGxhc3RNb2RpZmllZCwgZXRhZ30gPSBzaWduYXR1cmVzLnJlc3BvbnNlLmNhY2hlXG4gICAgY2FjaGUgPSBuZXcgQ2FjaGUgcmVxdWVzdFxuICAgIGRhdGEgPSBhd2FpdCBoYW5kbGVyIHJlcXVlc3QsIGNvbnRleHQsIGNhY2hlXG4gICAgbWV0YWRhdGEgPVxuICAgICAgaGVhZGVyczogXCJDb250ZW50LVR5cGVcIjogcmVxdWVzdC5hY2NlcHRcbiAgICBpZiBtYXhBZ2UgPT0gXCJtYW51YWxcIlxuICAgICAgbWV0YWRhdGEuaGVhZGVyc1tcIkNhY2hlLUNvbnRyb2xcIl0gPSBcIm1heC1hZ2U9I3tjYWNoZS5tYXhBZ2V9XCJcbiAgICBlbHNlXG4gICAgICBtZXRhZGF0YS5oZWFkZXJzW1wiQ2FjaGUtQ29udHJvbFwiXSA9IFwibWF4LWFnZT0je21heEFnZX1cIlxuICAgIGlmIGxhc3RNb2RpZmllZFxuICAgICAgbWV0YWRhdGEuaGVhZGVyc1tcIkxhc3QtTW9kaWZpZWRcIl0gPSBjYWNoZS50aW1lc3RhbXBcbiAgICBpZiBldGFnXG4gICAgICBtZXRhZGF0YS5oZWFkZXJzLkVUYWcgPSBjYWNoZS5ldGFnIHx8IG1kNSBkYXRhXG5cbiAgICByZXR1cm4ge2RhdGEsIG1ldGFkYXRhfVxuXG5leHBvcnQgZGVmYXVsdCBtZXRob2RcbiJdLCJzb3VyY2VSb290IjoiIn0=
//# sourceURL=method.coffee